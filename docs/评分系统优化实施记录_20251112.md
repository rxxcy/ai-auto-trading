# 评分系统优化实施记录

## 优化日期

2025-11-12

## 问题诊断

### 核心问题

即使降低评分阈值到40分，系统仍然找不到任何符合条件的开仓机会。

### 根本原因

**策略条件过于严格** - RSI阈值设置太极端：

1. **趋势跟踪策略**：
   - 做多：需要 RSI7 < 30（极度超卖）
   - 做空：需要 RSI7 > 70（极度超买）
   - 问题：在正常市场中，RSI达到这些极值的情况非常罕见

2. **均值回归策略**（更加严格）：
   - 做多：需要 RSI7 < 25
   - 做空：需要 RSI7 > 75
   - 问题：几乎不可能触发

3. **评分系统**：
   - wait信号直接给0分（已在之前修复）
   - 现在给予基础分：45分（趋势明确）、55分（最佳时机）、30分（震荡市）

## 实施的优化

### 1. 趋势跟踪策略 (src/strategies/trendFollowingStrategy.ts)

| 条件 | 修改前 | 修改后 | 变化 |
|------|--------|--------|------|
| 做多-RSI阈值 | < 30 | < 40 | ✅ 提高10点 |
| 做空-RSI阈值 | > 70 | > 60 | ✅ 降低10点 |

**效果**：更容易捕捉趋势中的回调/反弹机会

### 2. 均值回归策略 (src/strategies/meanReversionStrategy.ts)

| 条件 | 修改前 | 修改后 | 变化 |
|------|--------|--------|------|
| 做多-入场阈值 | < 25 | < 35 | ✅ 提高10点 |
| 做空-入场阈值 | > 75 | > 65 | ✅ 降低10点 |
| 做多-极端加分 | < 20 | < 25 | ✅ 提高5点 |
| 做空-极端加分 | > 80 | > 75 | ✅ 降低5点 |

**效果**：震荡市中也能有合理的交易机会

### 3. 突破策略 (src/strategies/breakoutStrategy.ts)

| 条件 | 修改前 | 修改后 | 变化 |
|------|--------|--------|------|
| 做多-RSI范围 | [40, 70] | [35, 75] | ✅ 扩大范围 |
| 做空-RSI范围 | [30, 60] | [25, 65] | ✅ 扩大范围 |

**效果**：避免因RSI略微偏离而错过强势突破

### 4. 评分系统 (src/services/opportunityScorer.ts)

**已在之前优化，本次确认**：

```typescript
// wait信号根据市场状态给予基础分
if (strategyResult.action === "wait") {
  if (marketState.state === "downtrend_continuation" || 
      marketState.state === "uptrend_continuation") {
    baseScore = 45; // 趋势明确
  } else if (marketState.state === "downtrend_overbought" || 
             marketState.state === "uptrend_oversold") {
    baseScore = 55; // 最佳时机
  } else if (marketState.state.startsWith("ranging")) {
    baseScore = 30; // 震荡市
  }
}
```

### 5. 评分阈值配置 (.env)

```bash
MIN_OPPORTUNITY_SCORE=40  # 从60降低到40
```

## 优化原理

### RSI指标正常分布

在正常市场条件下，RSI7的分布大致如下：

- **RSI < 30**：极度超卖，出现频率 < 5%
- **RSI 30-40**：超卖，出现频率 10-15%
- **RSI 40-60**：中性，出现频率 60-70%
- **RSI 60-70**：超买，出现频率 10-15%
- **RSI > 70**：极度超买，出现频率 < 5%

### 修改前的问题

- 等待 RSI < 30 或 > 70，意味着只在极少数情况（< 5%）下开仓
- 导致系统长期无法找到开仓机会

### 修改后的改进

- 等待 RSI < 40 或 > 60，出现频率提高到 15-25%
- 既保持了对回调/反弹的识别，又不至于过度保守

## 预期效果

1. **开仓机会增加**：
   - 趋势跟踪策略：从几乎没有机会 → 可捕捉中等回调
   - 均值回归策略：震荡市中也能有合理机会
   - 突破策略：不因RSI略微偏离而错过机会

2. **评分分布改善**：
   - 40-50分：可接受的机会（AI判断是否开仓）
   - 50-60分：中等机会（值得考虑）
   - 60分以上：优质机会（强烈推荐）

3. **风险控制**：
   - 仍然避免极端追高杀跌（RSI过极端会降低信号强度）
   - wait信号有基础分，AI可综合判断
   - 保留多重验证机制（趋势、动量、波动率）

## 验证方法

### 1. 重新运行集成测试

```bash
npx tsx scripts/test-integration-phase4.ts
```

**期望结果**：

- 评分阈值40分，应该能找到1-3个机会
- 评分阈值50分，应该能找到0-2个机会

### 2. 实盘环境测试（需配置API）

```bash
# 确保 .env 中配置了正确的交易所API
EXCHANGE=binance  # 或 gate
BINANCE_API_KEY=your_key
BINANCE_API_SECRET=your_secret
BINANCE_USE_TESTNET=true  # 建议先用测试网
```

### 3. 监控实际评分分布

可以添加日志记录，观察一段时间内的评分分布情况。

## 后续调整建议

根据实盘数据，可以进一步优化：

1. **动态RSI阈值**：
   - 根据市场波动率动态调整RSI阈值
   - 高波动市场：放宽阈值
   - 低波动市场：收紧阈值

2. **增加"趋势延续"策略**：
   - 不等待回调，直接跟随强势趋势
   - 条件更宽松，适合趋势市

3. **评分权重调整**：
   - 提高趋势一致性权重（从25→30）
   - 降低信号强度权重（从30→25）
   - 强调趋势跟踪而非指标精准

4. **分级阈值系统**：
   - 40-50分：谨慎机会（小仓位）
   - 50-65分：中等机会（标准仓位）
   - 65分以上：优质机会（可加大仓位）

## 文件修改清单

| 文件 | 修改内容 | 状态 |
|------|---------|------|
| `.env` | MIN_OPPORTUNITY_SCORE=40 | ✅ 已修改 |
| `src/services/opportunityScorer.ts` | wait信号基础分 | ✅ 已确认 |
| `src/strategies/trendFollowingStrategy.ts` | RSI阈值：做多<40，做空>60 | ✅ 已修改 |
| `src/strategies/meanReversionStrategy.ts` | RSI阈值：做多<35，做空>65 | ✅ 已修改 |
| `src/strategies/breakoutStrategy.ts` | RSI范围扩大 | ✅ 已修改 |
| `docs/开仓机会评分系统-优化建议.md` | 添加实施记录 | ✅ 已更新 |

## 总结

本次优化通过**放宽RSI阈值**和**给予wait信号基础分**，解决了评分系统过于苛刻的问题。优化后的系统：

✅ 更容易找到合理的开仓机会  
✅ 保持了风险控制机制  
✅ 给予AI足够的决策灵活性  
✅ 符合实际市场的RSI分布特征  

下一步需要在实盘环境中验证效果，并根据数据反馈持续优化。

---

## 补充修复：突破策略K线数据传递 (2025-11-12)

### 问题发现

在调试突破策略时，发现 `breakoutStrategy.ts` 中的 `candles` 字段被硬编码为空数组：

```typescript
candles: [], // 突破策略需要K线历史，但当前简化处理
```

这导致突破策略：

- ❌ 无法识别关键支撑/阻力位（需要20根K线历史）
- ❌ 永远返回 `wait` 信号（因为数据不足）
- ❌ 无法参与机会评分

### 修复方案

#### 1. 扩展多时间框架数据结构

**文件**: `src/services/multiTimeframeAnalysis.ts`

```typescript
export interface TimeframeIndicators {
  // ...existing fields...
  
  // K线历史数据（用于突破策略等需要识别支撑/阻力位的策略）
  candles: any[];
}
```

在 `analyzeTimeframe` 函数中保留原始K线数据：

```typescript
return {
  // ...existing fields...
  candles, // 保留原始K线数据，供突破策略等使用
};
```

#### 2. 修复突破策略包装函数

**文件**: `src/strategies/breakoutStrategy.ts`

```typescript
export async function breakoutStrategy(
  symbol: string,
  direction: "long" | "short",
  marketState: MarketStateAnalysis,
  tf15m: any,
  tf1h: any
) {
  const timeframe15m = {
    close: tf15m.currentPrice,
    ema20: tf15m.ema20,
    ema50: tf15m.ema50,
    macd: tf15m.macd,
    macdSignal: tf15m.macdSignal || 0,  // 修复：使用真实值
    rsi7: tf15m.rsi7,
    rsi14: tf15m.rsi14,
    candles: tf15m.candles || [],       // 修复：使用真实K线数据
    volume: tf15m.volume,
    avgVolume: tf15m.avgVolume,
  };
  // ...rest of code...
}
```

### 测试验证

创建测试脚本 `scripts/test-breakout-strategy.ts`，运行结果：

#### ✅ BTC/USDT

- 15分钟K线数量: **96根**
- 1小时K线数量: **120根**
- 近期高点: 104861.3
- 近期低点: 102857.5
- 阻力位: 104861.3, 104596.8, 104375.3
- 支撑位: 103253.7, 103252.3, 103185

#### ✅ ETH/USDT

- 15分钟K线数量: **96根**
- 1小时K线数量: **120根**
- 近期高点: 3543.4
- 近期低点: 3448.83

#### ✅ SOL/USDT - **识别出真实突破机会**

- 15分钟K线数量: **96根**
- 近期支撑位: 157.74
- 当前价格: 157.82
- **突破做空信号**: ✅
  - 价格跌破支撑位 (157.82 < 157.74)
  - 信号强度: **56.9%**
  - 置信度: medium
  - 合理警告:
    - 成交量未放大(仅1.46x)
    - RSI7过低(19.2)可能超卖反弹

### 修复效果

| 指标 | 修复前 | 修复后 |
|-----|--------|--------|
| K线数据传递 | ❌ 空数组 | ✅ 96根15分钟K线 |
| 支撑/阻力位识别 | ❌ 无法识别 | ✅ 正确识别 |
| 突破信号检测 | ❌ 永远wait | ✅ 正常识别突破 |
| SOL突破做空机会 | ❌ 漏检 | ✅ 成功识别(56.9%) |

### 影响范围

- ✅ **突破策略**: 现在可以正常工作
- ✅ **趋势跟踪策略**: 不受影响（不需要K线历史）
- ✅ **均值回归策略**: 不受影响（不需要K线历史）
- ✅ **策略路由器**: 自动受益（突破策略可参与评分）

### 后续优化建议

1. **成交量过滤优化**
   - 当前要求成交量 >1.5倍平均值才确认突破
   - 可以根据市场特性动态调整阈值

2. **假突破过滤**
   - 添加"突破后回踩"确认机制
   - 避免追逐假突破

3. **多级支撑/阻力**
   - 不仅识别最近20根K线的高低点
   - 可以识别多级支撑阻力位（最近50根、100根）

4. **与趋势结合**
   - 上涨趋势中优先关注阻力位突破（做多）
   - 下跌趋势中优先关注支撑位突破（做空）

---

**本次修复总结**：

- 🎯 解决了突破策略因K线数据缺失而无法工作的关键问题
- ✅ 通过实际测试验证修复有效性（SOL突破机会成功识别）
- 📊 为系统增加了一种重要的交易策略（突破策略）
- 🔧 完善了数据流传递机制，为后续策略开发打下基础
