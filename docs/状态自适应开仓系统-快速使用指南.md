# 状态自适应开仓系统 - 快速使用指南

## 📋 系统概述

第四阶段已完成，系统现在具备以下核心能力：

1. **自动识别市场状态**（8种状态）
2. **智能选择策略**（3种策略）
3. **量化评估机会**（0-100分，5维度）
4. **记录决策依据**（便于后续分析）

## 🚀 快速开始

### 1. AI如何使用新系统

TradingAgent 现在可以调用 `analyzeOpeningOpportunities` 工具来获取最佳开仓机会：

```typescript
// AI会自动调用这个工具
const opportunities = await analyzeOpeningOpportunities({
  symbols: ["BTC", "ETH", "SOL"],  // 可选，不传则使用环境变量
  topN: 5,                          // 返回前5个最佳机会
  minScore: 30,                     // 最低评分阈值
  includeOpenPositions: false       // 自动过滤已有持仓
});

// 返回结果示例
{
  success: true,
  opportunities: [
    {
      symbol: "BTC",
      score: 85,
      recommendation: {
        action: "long",
        confidence: 0.85,
        leverage: 3,
        marketState: "uptrend_oversold",
        strategyType: "trend_following"
      },
      marketAnalysis: {
        currentPrice: 95000,
        rsi7: 28,
        rsi14: 35,
        trend: "上涨趋势",
        volatility: "normal"
      },
      reasoning: "上涨趋势中的超卖回调，技术指标对齐度高..."
    }
  ]
}
```

### 2. AI如何基于评分做决策

系统提示词已更新，AI会按照以下逻辑决策：

- **评分 ≥ 80分**：高质量机会，建议积极开仓
- **评分 60-79分**：中等机会，可以谨慎开仓
- **评分 < 60分**：低质量机会，不推荐开仓

### 3. 开仓时记录策略信息

当AI调用 `openPosition` 时，可以传入策略信息：

```typescript
// AI可以这样调用
await openPosition({
  symbol: "BTC",
  side: "long",
  leverage: 3,
  amountUsdt: 100,
  // 可选：记录策略信息
  marketState: "uptrend_oversold",
  strategyType: "trend_following",
  signalStrength: 0.85,
  opportunityScore: 85
});
```

这些信息会自动保存到数据库，便于后续分析。

## 📊 市场状态说明

### 8种市场状态（按优先级排序）

1. **uptrend_oversold** ⭐⭐⭐⭐⭐
   - 含义：上涨趋势中的超卖回调
   - 信号：做多
   - 策略：趋势跟踪
   - 特点：最佳做多时机

2. **downtrend_overbought** ⭐⭐⭐⭐⭐
   - 含义：下跌趋势中的超买反弹
   - 信号：做空
   - 策略：趋势跟踪
   - 特点：最佳做空时机

3. **uptrend_continuation** ⭐⭐⭐⭐
   - 含义：上涨趋势延续
   - 信号：做多
   - 策略：趋势跟踪
   - 特点：稳健做多

4. **downtrend_continuation** ⭐⭐⭐⭐
   - 含义：下跌趋势延续
   - 信号：做空
   - 策略：趋势跟踪
   - 特点：稳健做空

5. **ranging_oversold** ⭐⭐⭐
   - 含义：震荡市超卖
   - 信号：做多
   - 策略：均值回归
   - 特点：反弹机会

6. **ranging_overbought** ⭐⭐⭐
   - 含义：震荡市超买
   - 信号：做空
   - 策略：均值回归
   - 特点：回调机会

7. **ranging_neutral** ⭐
   - 含义：震荡市中性
   - 信号：观望
   - 策略：无
   - 特点：不建议交易

8. **no_clear_signal** ⭐
   - 含义：无明确信号
   - 信号：观望
   - 策略：无
   - 特点：不建议交易

## 🎯 量化评分体系

### 5个评分维度（总分100）

1. **信号强度** (30分)
   - 技术指标的对齐程度
   - RSI、MACD、EMA等是否一致

2. **趋势一致性** (25分)
   - 多时间框架是否一致
   - 15分钟、1小时、4小时趋势方向

3. **波动率适配** (20分)
   - 当前波动率是否适合交易
   - ATR是否在合理范围

4. **风险收益比** (15分)
   - 预期盈利空间 / 止损距离
   - 至少要达到2:1

5. **市场活跃度** (10分)
   - 成交量和流动性
   - 避免在低流动性时段交易

## 🔧 系统配置

### 环境变量配置（即将支持）

```bash
# 市场状态阈值
OVERSOLD_EXTREME_THRESHOLD=20    # 极端超卖
OVERSOLD_MILD_THRESHOLD=30       # 轻度超卖
OVERBOUGHT_EXTREME_THRESHOLD=80  # 极端超买
OVERBOUGHT_MILD_THRESHOLD=70     # 轻度超买

# 策略启用
ENABLE_TREND_FOLLOWING=true      # 趋势跟踪
ENABLE_MEAN_REVERSION=true       # 均值回归
ENABLE_BREAKOUT=true             # 突破策略

# 评分配置
MIN_OPPORTUNITY_SCORE=60         # 最低评分
MAX_OPPORTUNITIES_TO_SHOW=5      # 返回数量
```

## 📈 查看策略表现

### 查询数据库中的策略信息

```sql
-- 查看所有持仓的策略信息
SELECT 
  symbol,
  side,
  market_state,
  strategy_type,
  signal_strength,
  opportunity_score,
  unrealized_pnl,
  opened_at
FROM positions
WHERE quantity != 0
ORDER BY opportunity_score DESC;

-- 统计各策略的表现
SELECT 
  strategy_type,
  COUNT(*) as total_trades,
  AVG(unrealized_pnl) as avg_pnl,
  AVG(opportunity_score) as avg_score
FROM positions
WHERE strategy_type IS NOT NULL
GROUP BY strategy_type;

-- 统计各市场状态的表现
SELECT 
  market_state,
  COUNT(*) as total_trades,
  AVG(unrealized_pnl) as avg_pnl,
  AVG(opportunity_score) as avg_score
FROM positions
WHERE market_state IS NOT NULL
GROUP BY market_state;
```

## 🧪 测试系统

### 运行集成测试

```bash
# 测试新功能
npx tsx scripts/test-integration-phase4.ts

# 应该看到所有测试通过：
# ✅ 测试场景1（开仓机会分析）: 通过
# ✅ 测试场景2（默认配置）: 通过
# ✅ 测试场景3（结果格式验证）: 通过
# ✅ 测试场景4（数据库字段）: 通过
```

### 验证数据库字段

```bash
# 检查新字段是否存在
sqlite3 .voltagent/trading.db "PRAGMA table_info(positions);" | grep -E "market_state|strategy_type|signal_strength|opportunity_score"

# 应该看到：
# 19|market_state|TEXT|0||0
# 20|strategy_type|TEXT|0||0
# 21|signal_strength|REAL|0||0
# 22|opportunity_score|REAL|0||0
```

## ⚠️ 注意事项

1. **不影响现有风控**
   - 新系统只负责开仓决策
   - 止损/止盈继续使用现有系统（科学止损、R-Multiple等）
   - 不会修改任何风控参数

2. **AI保留最终决策权**
   - 量化评分仅供参考
   - AI可以基于更多因素综合判断
   - 评分高不代表必须开仓

3. **策略信息是可选的**
   - 即使不传策略信息，开仓也能正常执行
   - 但建议传入，便于后续分析

4. **自动过滤已持仓**
   - 系统会自动跳过已有持仓的币种
   - 避免同一币种开多个仓位

## 🚀 下一步

第五阶段计划：

1. ✨ 创建市场分析脚本，实时查看当前最佳机会
2. ✨ 增强监控面板，显示市场状态分布
3. ✨ 配置环境变量，灵活调整参数
4. ✨ 小规模实盘测试，验证系统有效性

## 📝 相关文档

- [完整实施方案](../TODO.md)
- [第四阶段完成总结](./第四阶段完成总结.md)
- [市场状态识别说明](../src/services/marketStateAnalyzer.ts)
- [策略路由器说明](../src/services/strategyRouter.ts)
- [机会评分系统说明](../src/services/opportunityScorer.ts)

## 💬 问题反馈

如有问题或建议，请查看相关源代码文件中的注释，或联系开发团队。
