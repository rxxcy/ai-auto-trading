# 开仓机会评分系统 - 优化建议

## 问题分析

### 当前问题

从集成测试结果看，即使将评分阈值降低到50分，系统仍然找不到符合条件的开仓机会：

```bash
评分 3 个机会...
评分完成，0 个机会达到最低评分 50
```

### 根本原因

1. **策略条件过于严格**
   - 趋势跟踪做多：需要上涨趋势 + 超卖回调（RSI7 < 30）
   - 趋势跟踪做空：需要下跌趋势 + 超买反弹（RSI7 > 70）
   - 当前市场：下跌趋势延续但没有超买反弹，所以所有策略都返回 `wait`

2. **评分直接归零**
   - 只要策略返回 `wait`，评分系统直接给0分
   - 导致即使有合理的做空机会也被过滤掉

3. **市场状态与策略不匹配**
   - 当前识别的状态：`downtrend_continuation`（下跌趋势延续）
   - 但趋势跟踪策略期望：`downtrend_overbought`（下跌中超买反弹）

## 解决方案

### 方案1：调整策略条件（推荐）⭐

**降低入场条件的严格程度**，允许在趋势延续时开仓：

#### 1.1 趋势跟踪做空策略优化

**当前逻辑**：

```typescript
// 需要超买反弹（RSI7 > 70）才做空
if (rsi7 <= 70) {
  return { action: 'wait', reason: '15分钟RSI7未超买，等待反弹' };
}
```

**优化后**：

```typescript
// 选项A：降低RSI阈值
if (rsi7 <= 60) {  // 从70降到60
  return { action: 'wait', reason: '15分钟RSI7未达到做空条件' };
}

// 选项B：允许趋势延续
if (marketState.state === 'downtrend_continuation' && rsi7 >= 50) {
  // 下跌趋势延续，RSI在50以上即可做空
  signalStrength = 0.6; // 中等信号强度
}
```

#### 1.2 评分系统优化

**当前逻辑**：

```typescript
// wait直接给0分
if (strategyResult.action === "wait") {
  return { totalScore: 0, ... };
}
```

**优化后**：

```typescript
// 允许观望信号也有一定评分
if (strategyResult.action === "wait") {
  // 根据市场状态给予基础分
  let baseScore = 0;
  if (marketState.state === "downtrend_continuation" || 
      marketState.state === "uptrend_continuation") {
    baseScore = 30; // 趋势明确给30分
  }
  
  return { 
    totalScore: baseScore, 
    breakdown: { signalStrength: baseScore, ... } 
  };
}
```

### 方案2：新增"趋势延续"策略

创建专门的趋势延续策略，不要求回调/反弹：

```typescript
// src/strategies/trendContinuationStrategy.ts

export function analyzeTrendContinuation(symbol, timeframes, marketState) {
  // 下跌趋势延续
  if (marketState.state === 'downtrend_continuation') {
    // 条件更宽松：
    // 1. EMA20 < EMA50（下跌趋势）
    // 2. MACD < 0（动量向下）
    // 3. RSI7 在40-70之间（避免极端）
    
    return {
      action: 'short',
      signalStrength: 0.6,
      recommendedLeverage: 2,
      reason: '下跌趋势延续，稳健做空',
    };
  }
  
  // 上涨趋势延续
  if (marketState.state === 'uptrend_continuation') {
    return {
      action: 'long',
      signalStrength: 0.6,
      recommendedLeverage: 2,
      reason: '上涨趋势延续，稳健做多',
    };
  }
  
  return { action: 'wait' };
}
```

### 方案3：调整评分权重

降低信号强度的权重，增加市场状态的权重：

**当前权重**：

```typescript
信号强度: 30分
趋势一致性: 25分
波动率适配: 20分
风险收益比: 15分
市场活跃度: 10分
```

**优化权重**：

```typescript
趋势一致性: 30分  // 提高，强调趋势跟踪
信号强度: 25分    // 降低，避免过度依赖指标
波动率适配: 20分
风险收益比: 15分
市场活跃度: 10分
```

### 方案4：降低默认评分阈值

**当前阈值**：

```bash
MIN_OPPORTUNITY_SCORE=60  # 60分
```

**建议调整**：

```bash
MIN_OPPORTUNITY_SCORE=40  # 降到40分
```

**理由**：

- 60分属于"中等机会"，标准较高
- 40-60分为"可接受机会"，AI可以根据其他因素综合判断
- 保留评分机制的意义（不是直接开仓）

## 推荐实施方案

### 阶段1：快速优化（立即可做）

1. ✅ **降低评分阈值**：从60分降到40分

   ```bash
   # .env
   MIN_OPPORTUNITY_SCORE=40
   ```

2. ✅ **允许wait信号有基础分**：
   - 趋势明确（uptrend/downtrend_continuation）：给30分基础分
   - 震荡市（ranging）：给20分基础分
   - 无信号：0分

3. ✅ **降低RSI条件**：
   - 做多：RSI7 < 35（从30提高到35）
   - 做空：RSI7 > 65（从70降低到65）

### 阶段2：中期优化（1-2天）

1. 创建趋势延续策略
2. 调整评分权重
3. 添加更多市场状态判断逻辑

### 阶段3：长期优化（持续迭代）

1. 根据实盘数据调整参数
2. 机器学习优化评分模型
3. 动态阈值调整

## 已实施的优化（2025-11-12）

### ✅ 阶段1优化已完成

#### 1. 降低评分阈值

- ✅ `.env` 文件中设置 `MIN_OPPORTUNITY_SCORE=40`
- ✅ `opportunityAnalysis.ts` 默认值改为40分

#### 2. wait信号基础分

- ✅ `opportunityScorer.ts` 中实现wait信号评分逻辑：
  - 下跌/上涨趋势延续（`downtrend_continuation`/`uptrend_continuation`）：**45分**
  - 回调/反弹最佳时机（`downtrend_overbought`/`uptrend_oversold`）：**55分**
  - 震荡市（`ranging_*`）：**30分**
  - 无明确信号：**0分**

#### 3. 放宽RSI阈值

**趋势跟踪策略** (`trendFollowingStrategy.ts`)：

- 做多条件：RSI7 < 40（从30放宽到40） ✅
- 做空条件：RSI7 > 60（从70降低到60） ✅

**均值回归策略** (`meanReversionStrategy.ts`)：

- 做多条件：RSI7 < 35（从25放宽到35） ✅
- 做空条件：RSI7 > 65（从75降低到65） ✅
- 极端加分阈值：
  - 做多：RSI7 < 25（从20放宽到25） ✅
  - 做空：RSI7 > 75（从80降低到75） ✅

**突破策略** (`breakoutStrategy.ts`)：

- 做多范围：RSI7 ∈ [35, 75]（从[40, 70]放宽到[35, 75]） ✅
- 做空范围：RSI7 ∈ [25, 65]（从[30, 60]放宽到[25, 65]） ✅

### 预期效果

优化后的RSI阈值更加合理：

- **趋势跟踪**：不再等待极端回调，捕捉更多趋势机会
- **均值回归**：降低入场门槛，震荡市也能有机会
- **突破策略**：放宽范围，避免错过强势突破

### 下一步验证

1. 重新运行集成测试，观察评分分布
2. 在实盘环境中测试（需配置正确的交易所API）
3. 根据实盘反馈进一步调整参数

---

## 具体修改代码

### 修改1：opportunityScorer.ts

```typescript
// 在 scoreOpportunity 函数中
if (strategyResult.action === "wait") {
  // 根据市场状态给予基础分
  let baseScore = 0;
  let reason = strategyResult.reason;
  
  if (marketState.state === "downtrend_continuation" || 
      marketState.state === "uptrend_continuation") {
    baseScore = 35; // 趋势明确
    reason = `趋势明确但暂无精确入场点。${strategyResult.reason}`;
  } else if (marketState.state.startsWith("ranging")) {
    baseScore = 25; // 震荡市
    reason = `震荡市场，等待更好机会。${strategyResult.reason}`;
  }
  
  return {
    symbol: strategyResult.symbol,
    totalScore: baseScore,
    breakdown: {
      signalStrength: baseScore,
      trendConsistency: 0,
      volatilityFit: 0,
      riskRewardRatio: 0,
      liquidity: 0,
    },
    confidence: "low",
    recommendation: {
      strategyType: "none",
      direction: "wait",
      confidence: "low",
      reason,
    },
  };
}
```

### 修改2：.env配置

```bash
# 当前配置
MIN_OPPORTUNITY_SCORE=60

# 建议修改为
MIN_OPPORTUNITY_SCORE=40
```

### 修改3：趋势跟踪策略

```typescript
// trendFollowingStrategy.ts - 做空部分

// 3. 检查15分钟超买（降低阈值）
const overbought = timeframe15m.rsi7 > 65; // 从70改为65
if (!overbought && marketState.state !== 'downtrend_continuation') {
  return {
    symbol,
    action: 'wait',
    // ...
  };
}

// 如果是趋势延续且RSI适中，也可以考虑
if (marketState.state === 'downtrend_continuation' && 
    timeframe15m.rsi7 >= 50 && timeframe15m.rsi7 <= 70) {
  signalStrength = 0.6; // 中等强度
  warnings.push('趋势延续信号，RSI适中');
}
```

## 验证方法

修改后重新运行测试：

```bash
npx tsx scripts/test-integration-phase4.ts
```

预期结果：

```bash
评分 3 个机会...
评分完成，1-2 个机会达到最低评分 40
```

## 总结

**核心问题**：策略条件太严格 + 评分系统太苛刻

**解决思路**：

1. 降低评分阈值（40分）
2. 允许wait信号有基础分
3. 适当放宽策略条件

**平衡点**：

- 不能太宽松：避免频繁错误开仓
- 不能太严格：避免错过合理机会
- AI保留最终决策权：评分只是参考，AI根据更多因素综合判断

**建议立即采用**：方案1的阶段1优化，快速见效且风险可控。
