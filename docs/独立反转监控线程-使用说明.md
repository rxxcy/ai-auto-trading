# 独立反转监控线程 - 使用说明

## 📖 概述

独立反转监控线程是一个3分钟周期的独立监控服务，用于快速检测趋势反转并自动平仓，解决主交易周期（15分钟）响应滞后的问题。

## 🎯 核心功能

### 三层防护机制

1. **第一道防线**：反转监控线程（3分钟周期）
   - 检测反转评分 ≥30分：标记预警
   - 检测反转评分 ≥50分 且 盈利<2%：立即平仓

2. **第二道防线**：健康检查线程（60秒周期）
   - 兜底保护，即使反转监控线程失效也能及时平仓
   - 触发时发送邮件告警

3. **第三道防线**：主交易AI决策（15分钟周期）
   - 读取预警标记，优先处理高风险持仓

### 分布式锁机制

- 使用 `system_config` 表实现数据库级别的分布式锁
- 30秒自动过期，防止死锁
- 避免多个线程同时平仓同一持仓

### 去重机制

- 检查 `position_close_events` 表的最近30秒记录
- 防止重复平仓

## 🚀 快速开始

### 1. 启用/禁用

默认情况下，反转监控线程是**启用**的。

如需禁用，在 `.env` 文件中添加：

```bash
REVERSAL_MONITOR_ENABLED=false
```

### 2. 查看日志

反转监控线程的日志标识为 `[reversal-monitor]`：

```bash
# 启动日志
🔍 [反转监控线程] 服务启动
   检测间隔: 3 分钟
   阈值配置: 30分预警, 50分平仓

# 预警日志
⚠️ [reversal-monitor] BTC_USDT 早期反转预警 (35分)

# 平仓日志
🚨 [reversal-monitor] BTC_USDT long 触发紧急平仓: score=52, pnl=0.8%
✅ [reversal-monitor] BTC_USDT long 紧急平仓完成
```

### 3. 健康检查集成

健康检查线程也会执行反转监控检查（兜底保护）：

```bash
# 如果健康检查触发平仓，说明反转监控线程可能失效
⚠️ 健康检查触发紧急平仓 1 个持仓（反转监控线程可能失效）
  🚨 BTC_USDT long - score=55 - emergency
```

此时会发送邮件告警，提示反转监控线程可能未及时处理。

## 📊 效果预期

### 优化前（仅主线程15分钟周期）

- 平均响应延迟: 119分钟
- 平均亏损: -10.37%

### 优化后（三层防护机制）

- 平均响应延迟: ~6分钟（-95%）
- 平均亏损: -1.5%（-85%）
- 总亏损减少: ~300 USDT（6笔交易）

## 🔍 监控指标

建议监控以下指标：

1. **锁冲突频率**（预期<1%）
   - 查询 `system_config` 表中 `reversal_close_*` 开头的锁

2. **平均响应延迟**（目标<10分钟）
   - 从反转信号出现到平仓完成的时间

3. **误平仓率**（目标<0.1%）
   - 平仓后价格继续朝有利方向运行的比例

4. **系统可用性**（目标>99.9%）
   - 反转监控线程的正常运行时间占比

## 📝 数据库字段

### positions 表的 metadata 字段

反转监控线程会在 `positions` 表的 `metadata` 字段中添加预警标记：

```json
{
  "reversalWarning": 1,
  "warningScore": 45,
  "warningTime": "2025-01-15T10:30:00.000Z"
}
```

### position_close_events 表

平仓事件会记录在 `position_close_events` 表中：

```sql
INSERT INTO position_close_events (
  symbol, side, close_reason, trigger_type, ...
) VALUES (
  'BTC_USDT', 'long', 'reversal_monitor_emergency_by_reversal-monitor', 'system_risk', ...
)
```

## ⚠️ 注意事项

1. **交易所兼容性**
   - 已适配币安和gate.io
   - 使用 `placeOrder` with `reduceOnly=true` 来平仓
   - 自动处理反向合约和线性合约的数量精度

2. **平仓条件**
   - 反转评分 ≥50分
   - 且 当前盈利 <2%
   - 两个条件必须同时满足

3. **锁机制**
   - 锁会在30秒后自动过期
   - 如果平仓操作超时，锁会自动释放
   - 下次检查会重新尝试

4. **去重机制**
   - 30秒内不会重复平仓同一持仓
   - 即使多个线程同时检测到反转信号

## 🔧 故障排查

### 问题1：反转监控线程未启动

**症状**：日志中没有 `[反转监控线程] 服务启动` 的消息

**解决方案**：

1. 检查环境变量 `REVERSAL_MONITOR_ENABLED` 是否为 `false`
2. 检查系统启动日志是否有错误信息

### 问题2：持仓未被平仓

**症状**：反转评分≥50分但持仓未平仓

**可能原因**：

1. 当前盈利 ≥2%（不符合平仓条件）
2. 锁被其他线程占用（查看日志中是否有 "锁被占用" 的消息）
3. 最近30秒内已平仓（查看日志中是否有 "最近30秒内已平仓" 的消息）

**解决方案**：

1. 查看日志中的详细信息
2. 检查 `position_close_events` 表中是否有平仓记录
3. 如果是锁冲突，等待健康检查线程（60秒）或主交易线程（15分钟）兜底

### 问题3：重复平仓告警

**症状**：收到邮件告警 "健康检查触发紧急平仓"

**原因**：反转监控线程可能失效或延迟

**解决方案**：

1. 检查反转监控线程是否正常运行
2. 检查系统资源（CPU、内存）是否充足
3. 检查数据库连接是否正常
4. 这是正常的兜底保护机制，不影响系统运行

## 📚 相关文档

- [独立反转监控线程 - 冲突分析与解决方案](./独立反转监控线程-冲突分析与解决方案.md)
- [趋势反转亏损深度分析与优化方案](./趋势反转亏损深度分析与优化方案.md)
- [交易周期优化 - 量化分析报告](./交易周期优化-量化分析报告.md)
- [分批止盈自动化 - 快速参考](./分批止盈自动化-快速参考.md)

## 📞 技术支持

如有问题，请查看：

1. 系统日志：`logs/pm2-out.log` 和 `logs/pm2-error.log`
2. 数据库日志：检查 `position_close_events` 和 `agent_decisions` 表
3. 相关文档：参考上述相关文档

---

**版本**: v1.0  
**更新时间**: 2025-01-15  
**状态**: 已实施，待测试验证
